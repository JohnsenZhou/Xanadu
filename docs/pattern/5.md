# 发布-订阅模式

## 定义

发布-订阅模式又叫观察者模式，它定义对象之间一种一对多的依赖关系，当一个对象的状态发生改变时，所有依赖于它的对象都将得到通知。

## 真实世界类比

![发布-订阅模式](https://refactoringguru.cn/images/patterns/content/observer/observer-comic-2-zh-2x.png)

如果你订阅了一份杂志或报纸， 那就不需要再去报摊查询新出版的刊物了。 出版社 （即应用中的 “发布者”） 会在刊物出版后 （甚至提前） 直接将最新一期寄送至你的邮箱中。

出版社负责维护订阅者列表， 了解订阅者对哪些刊物感兴趣。 当订阅者希望出版社停止寄送新一期的杂志时， 他们可随时从该列表中退出。

## 模式实现

```js
class Events {
  constructor() {
    this.cache = {} // 缓存表
  }
  // 增加订阅
  listen(key, fn) {
    if (!this.cache[key]) {
      this.cache[key] = [] // 初始化指定时间缓存列表
    }
    this.cache[key].push(fn) // 将事件加入到对应的缓存列表中
  }
  // 触发订阅
  trigger() {
    const key = Array.prototype.shift.call(arguments) // 获取第一个参数
    const fns = this.cache[key]
    if (!fns || fns.length === 0) return // 如果没有对应绑定信息
    fns.forEach(fn => {
      fn.apply(this, arguments)
    })
  }
  // 取消订阅
  remove(key, fn) {
    const fns = this.cache[key]
    if (!fns) return // 如果key对应的消息没有人订阅，直接返回
    if (fn) {
      fns.forEach((item, index) => {
        if (item === fn) {
          fns.splice(index, 1) // 删除订阅者的回调函数
        }
      })
    } else {
      fns.length = 0 // 如果没定义指定回调函数，直接取消key对应的所有订阅
    }
  }
}
```

## 测试


